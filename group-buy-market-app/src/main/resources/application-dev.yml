server:
  port: 8091
  # 1核2G内存，可默认配置 200；4核8G内存【accept-count=1000、max-threads=800、max-connections=10000】，线程数经验值800。线程池过大，cpu调度会消耗大量时间
  tomcat:
    mbeanregistry:
      enabled: true
    max-connections: 10000 # 最大连接数
    threads:
      max: 800         # 提高并发处理能力（按机器资源可调低为400/200）
      min-spare: 50   # 初始化线程数,最小空闲线程数
    accept-count: 1000  # 等待队列长度
    connection-timeout: 5s
    keep-alive-timeout: 60s

# 线程池配置
thread:
  pool:
    executor:
      config:
        core-pool-size: 20
        max-pool-size: 50
        keep-alive-time: 5000
        block-queue-size: 5000
        # 当线程池中的任务队列已满，并且没有空闲线程可以执行新任务时，CallerRunsPolicy 会将任务回退到调用者线程中运行。这种策略适用于不希望丢失任务且可以接受调用者线程被阻塞的场景。
        policy: CallerRunsPolicy

# 数据库配置；启动时配置数据库资源信息
spring:
  datasource:
    username: root
    password: 123456
    url: jdbc:mysql://127.0.0.1:13306/group_buy_market?useUnicode=true&characterEncoding=utf8&autoReconnect=true&zeroDateTimeBehavior=convertToNull&serverTimezone=Asia/Shanghai&useSSL=true&sessionVariables=sql_mode='NO_ENGINE_SUBSTITUTION,STRICT_TRANS_TABLES'
    driver-class-name: com.mysql.cj.jdbc.Driver
    type: com.zaxxer.hikari.HikariDataSource
    hikari:
      pool-name: Retail_HikariCP
      minimum-idle: 30 #最小空闲连接数量
      idle-timeout: 60000 #空闲连接存活最大时间，默认600000（10分钟）
      maximum-pool-size: 100 #连接池最大连接数，默认是10
      auto-commit: true  #此属性控制从池返回的连接的默认自动提交行为,默认值：true
      max-lifetime: 300000 #此属性控制池中连接的最长生命周期，值0表示无限生命周期，默认1800000即30分钟
      connection-timeout: 30000 #数据库连接超时时间,默认30秒，即30000
      connection-test-query: SELECT 1
      register-mbeans: true
  # RabbitMQ
  rabbitmq:
    addresses: 127.0.0.1
    port: 15672
    username: admin
    password: admin
    listener:
      simple:
        prefetch: 1 # 每次投递n个消息，消费完在投递n个
    template:
      delivery-mode: persistent # 确保全局默认设置为持久化（可选）
    # 消息配置
    config:
      # 生产者
      producer:
        # 绑定交换机，统一一套交换机
        exchange: group_buy_market_exchange
        # 消息主题配置；路由key、队列
        topic_team_success:
          # 消息主题
          routing_key: topic.team_success
          # 消费队列
          queue: group_buy_market_queue_2_topic_team_success
        topic_team_refund:
          # 消息主题
          routing_key: topic.team_refund
          # 消费队列
          queue: group_buy_market_queue_2_topic_team_refund
  # Spring Cloud Stream 配置（参考 NFTurbo）
  # 注意：function.definition 只需要定义 Consumer（in-0），Producer（out-0）不需要定义
  cloud:
    function:
      # 参考 NFTurbo：正常流程需要消息监听器，批量消费消息并异步扣减数据库库存
      # 正常流程：hotGoodsOrderCreate 监听器处理订单创建成功消息，异步扣减数据库库存
      # 异常流程：hotGoodsOrderPreCancel 监听器处理延迟检查消息
      definition: orderCreate;hotGoodsOrderCreate;hotGoodsOrderCancel;normalGoodsOrderCancel;hotGoodsOrderPreCancel;normalGoodsOrderPreCancel
    stream:
      rocketmq:
        bindings:
          # 热点商品订单创建事务消息
          hotGoodsOrderCreate-out-0:
            producer:
              producerType: Trans
              transactionListener: hotGoodsOrderCreateTransactionListener
          # 普通商品订单创建事务消息
          normalGoodsOrderCreate-out-0:
            producer:
              producerType: Trans
              transactionListener: normalGoodsOrderCreateTransactionListener
          # 通用订单创建事务消息（旧拼团订单）
          orderCreate-out-0:
            producer:
              producerType: Trans
              transactionListener: orderCreateTransactionListener
      bindings:
        # 热点商品订单创建（事务消息 - Producer）
        hotGoodsOrderCreate-out-0:
          content-type: application/json
          destination: hotGoodsOrderCreate-out-0
          group: hot-goods-group
          binder: rocketmq
        # 热点商品订单创建（事务消息 - Consumer）
        # 参考 NFTurbo：正常流程需要消息监听器，批量消费消息并异步扣减数据库库存
        # 注意：代码已兼容单个消息和批量消息，如果批量消费不生效，代码会自动将单个消息包装成 List 处理
        hotGoodsOrderCreate-in-0:
          content-type: application/json
          destination: hotGoodsOrderCreate-out-0
          group: hot-goods-create-group
          binder: rocketmq
        # 普通商品订单创建（事务消息）
        normalGoodsOrderCreate-out-0:
          content-type: application/json
          destination: normalGoodsOrderCreate-out-0
          group: normal-goods-group
          binder: rocketmq
        # 通用订单创建（事务消息）
        orderCreate-out-0:
          content-type: application/json
          destination: orderCreate-out-0
          group: order-create-group
          binder: rocketmq
        # 热点商品订单取消（普通消息）
        hotGoodsOrderCancel-in-0:
          content-type: application/json
          destination: hotGoodsOrderCancel
          group: hot-goods-cancel-group
          binder: rocketmq
        # 普通商品订单取消（普通消息）
        normalGoodsOrderCancel-in-0:
          content-type: application/json
          destination: normalGoodsOrderCancel
          group: normal-goods-cancel-group
          binder: rocketmq
        # 热点商品订单疑似取消（延迟消息 - Producer）
        hotGoodsOrderPreCancel-out-0:
          content-type: application/json
          destination: hotGoodsOrderPreCancel
          group: hot-goods-pre-cancel-group
          binder: rocketmq
        # 热点商品订单疑似取消（延迟消息 - Consumer）
        hotGoodsOrderPreCancel-in-0:
          content-type: application/json
          destination: hotGoodsOrderPreCancel
          group: hot-goods-pre-cancel-group
          binder: rocketmq
        # 普通商品订单疑似取消（延迟消息）
        normalGoodsOrderPreCancel-in-0:
          content-type: application/json
          destination: normalGoodsOrderPreCancel
          group: normal-goods-pre-cancel-group
          binder: rocketmq
        # 订单创建消息（补偿消息）
        orderCreate-in-0:
          content-type: application/json
          destination: orderCreate-out-0
          group: order-create-consumer-group
          binder: rocketmq
# RocketMQ 配置（保留用于兼容性，但主要使用 Spring Cloud Stream 配置）
rocketmq:
  name-server: 127.0.0.1:9876
  producer:
    group: group-buy-market-producer-group
    send-message-timeout: 3000
    retry-times-when-send-failed: 2
  consumer:
    group: group-buy-market-consumer-group
    pull-batch-size: 32

# MyBatis 配置【如需使用记得打开】
mybatis:
  mapper-locations: classpath:/mybatis/mapper/*.xml
  config-location:  classpath:/mybatis/config/mybatis-config.xml

# Redis
redis:
  sdk:
    config:
      host: 127.0.0.1
      port: 16379
      pool-size: 10
      min-idle-size: 5
      idle-timeout: 30000
      connect-timeout: 5000
      retry-attempts: 3
      retry-interval: 1000
      ping-interval: 60000
      keep-alive: true

# 扳手工程；通用配置组件「配置中心、设计模式框架、限流服务」
xfg:
  wrench:
    config:
      system: group-buy-market
      register:
        host: 127.0.0.1
        port: 16379

# 日志；logstash部署的服务器IP
logstash:
  host: 127.0.0.1

# 监控配置 Prometheus + Grafana
management:
  endpoints:
    web:
      exposure:
        include: "*" # 暴露所有端点，包括自定义端点
  endpoint:
    health:
      show-details: always # 显示详细的健康检查信息
  metrics:
    export:
      prometheus:
        enabled: true # 启用Prometheus
  prometheus:
    enabled: true # 启用Prometheus端点

# XXL-Job 配置（参考 NFTurbo）
xxl:
  job:
    enabled: true
    admin-addresses: http://127.0.0.1:8080/xxl-job-admin/  # XXL-Job 管理平台地址
    app-name: group-buy-market-executor  # 执行器应用名称（需要在 XXL-Job 管理平台创建）
    access-token: default_token  # 访问令牌（需要在 XXL-Job 管理平台配置）
    ip: host.docker.internal  # 执行器 IP（Docker Desktop会自动解析为宿主机IP，让容器可以访问）
    port: 9999  # 执行器端口
    log-path: /data/applogs/xxl-job/jobhandler  # 日志路径
    log-retention-days: 30  # 日志保留天数

# 日志
logging:
  level:
    root: info
    com.zaxxer.hikari: DEBUG
  config: classpath:logback-spring.xml