# Grafana MCP server https://github.com/grafana/mcp-grafana
# 执行脚本；docker compose -f docker-compose-grafana-aliyun.yml up -d
services:
  # 数据采集
  prometheus:
    image: registry.cn-hangzhou.aliyuncs.com/xfg-studio/prometheus:2.47.2
    container_name: prometheus
    restart: always
    ports:
      - 9090:9090
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
    networks:
      - my-network

  # 监控界面
  grafana:
    image: registry.cn-hangzhou.aliyuncs.com/xfg-studio/grafana:10.2.0
    container_name: grafana
    restart: always
    ports:
      - 3000:3000
    depends_on:
      - prometheus
    # 为避免本地 grafana.ini 覆盖导致数据库连不上，先不整体挂载
    # volumes:
    #   - ./grafana:/etc/grafana
    environment:
      - GF_SERVER_HTTP_PORT=3000
      - GF_DATABASE_TYPE=sqlite3
      - GF_DATABASE_PATH=/var/lib/grafana/grafana.db
      # 如外部 MySQL，请改为 host.docker.internal:3306 并配置账号密码；默认可先用 SQLite
      # - GF_DATABASE_TYPE=mysql
      # - GF_DATABASE_HOST=host.docker.internal:3306
      # - GF_DATABASE_NAME=grafana
      # - GF_DATABASE_USER=grafana
      # - GF_DATABASE_PASSWORD=your_pass
      # - GF_DATABASE_SSL_MODE=disable
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "-", "http://localhost:3000/api/health"]
      interval: 10s
      timeout: 5s
      retries: 6
    networks:
      - my-network

  # 监控服务 mcp https://github.com/grafana/mcp-grafana
  grafana-mcp:
    image: registry.cn-hangzhou.aliyuncs.com/xfg-studio/grafana-mcp:latest
    container_name: grafana-mcp
    ports:
      - "8000:8000"
    environment:
      - GRAFANA_URL=http://grafana:3000
      - GRAFANA_API_KEY=glsa_ELtYrUYyZUsZQSrwUmTC46ndtYacghyc_88cd15c4
    depends_on:
      grafana:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - my-network

networks:
  my-network:
    driver: bridge
